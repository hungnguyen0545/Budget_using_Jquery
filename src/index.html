<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:100,300,400,600" rel="stylesheet" type="text/css">
    <link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" type="text/css">
    <link href="css/style.css"  rel="stylesheet" type="text/css">
    <title>MY'S BUDGET</title>
</head>
<body>
            <div class="top">
                <div class="budget">
                    <div class="budget-title">
                        <span >
                            Available Budget in <span class="current_time"></span>
                        </span>
                    </div>
                    <div class="budget-value">
                        <span></span>
                    </div>
                    <div class="budget-inc-exp">
                        <div class="card-container">
                            <div class="budget-inc">
                                <span class="budget-inc-title"> INCOME </span>
                                <div class="right">
                                    <span class="budget-inc-value"></span>
                                </div>
                            </div>
                        </div>
                        <div class="card-container">
                            <div class="budget-exp">
                                <span class="budget-exp-title"> EXPENSES </span>
                                <div class="right">
                                    <span class="budget-exp-value"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="history-view-box">
                    <a class="history-btn" href="../history.html">
                        <img src="https://img.icons8.com/plasticine/100/000000/time-machine.png"
                        />
                    </a>
                </div>
            </div>
            <div class="middle">
                <div class="add-container">
                    <select class="add-type">
                        <option value="inc"> + </option>
                        <option value="exp"> - </option>
                    </select>
                    <input type="text" class="add-description" 
                    placeholder="Add description">
                    <input type="number" class="add-value"
                    placeholder="Value">
                    <button class="add-btn" type="button">
                        <i class="ion-ios-checkmark-outline"></i>
                    </button>
                </div>
            </div>
            <div class="bottom container">
                <div class="inc-exp-list-display">
                    <div class="inc-table">
                        <div class="inc-title">
                            INCOME
                        </div>
                        <div class="inc-list">
                            
                        </div>
                    </div>
                        <div class="exp-table">
                            <div class="exp-title">
                                EXPENSE
                            </div>
                            <div class="exp-list">    
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
 </body>
    <script  type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="../lowdb.js" ></script>  -->
    <script>
        $(window).on('load',async function() {
            let budget_data = await getData();
            $('.add-btn').on('click',async function()
            {   
                await add(budget_data);
                console.log(budget_data);
            })
        })
    </script>
     <!--GET DATA FROM JSON-SERVER-->
     <script>      
        async function  getData()
        {
            var budget_data ; 
            await $.ajax({
                url : 'http://localhost:3000/db',
                method : 'GET',
                success : function(db)
                {
                    budget_data = db;
                    displayBudget(budget_data);
                }
            })
            return budget_data;
        }
    </script>
    <!-- DISPLAY INFORMATION ABOUT BUDGET ONTO SCREEN-->
    <script>
        function displayBudget(data)
        {
        // get budget value, inc and exp value from budget_data
        let budget =  data.budget['value'];
        let total_inc = data.total['inc'];
        let total_exp = data.total['exp'];
        //add value into class 
        $('.budget-value').text(budget);
        $('.budget-inc-value').text(`+ ${total_inc} đ`);
        $('.budget-exp-value').text(`- ${total_exp} đ`);
        }
    </script>
   <!-- ADD -->
   <script>
       async function add(data)
       {
           //get input value after user click add or enter
           let type, description,value;
            type = $('.add-type').children("option:selected").val();
            description = $('.add-description').val();
            value = Number($('.add-value').val());
           //check all of field already filled
            let newId ;
            let TypeofBudget = data[type];
            // create newid for new item
            // -- newId = currentId + 1 ;
            (TypeofBudget.length > 0)
            ? newId = Number(TypeofBudget[TypeofBudget.length-1].id ) + 1
            : newId = 0 ;
            let item = {
                'id' : newId,
                'description' : description,
                'value' : value
            }
            await $.ajax(
            {
                url : `http://localhost:3000/${type}`,
                method : 'POST',
                contentType : 'application/json',
                data : JSON.stringify(item),
                success : function(){
                    console.log(' add data successful !!! ');
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert(errorThrown);
                 }
            })

            // re calculate for inc,exp after insert item
            let sum=0,total;
            data[`${type}`].forEach( item => {
                sum += item.value;
            }) 
            (type === "inc") 
            ?
            total = {
             "inc": sum ,
             "exp": data.total["exp"]
            }
            :
            total = {
                "inc": data.total["inc"],
                "exp": sum 
            }
            await $.ajax({
                url : `http://localhost:3000/total`,
                method : 'PUT',
                contentType : 'application/json',
                data : JSON.stringify(total),
                success : function()
                {
                    alert('update data successful');
                },
                error : function(errorThrown)
                {
                    alert(errorThrown);
                }
            })

             // update the budget value after insert item 
           let budget = data.total['inc'] - data.total['exp'];
           await $.ajax({
                url : 'http://localhost:3000/budget',
                method : 'PUT',
                contentType : 'application/json',
                data : JSON.stringify(budget),
                success : function()
                {
                    alert('update data successful');
                },
                error : function(errorThrown)
                {
                    alert(errorThrown);
                }
             })
            return console.log('hoàn thành việc thêm dữ liệu ');
       }
   </script>
    </html>
